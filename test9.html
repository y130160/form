<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>דף עדכון דוח</title>
  <style>
    /* איפוס סגנונות בסיסי */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Times New Roman', serif;
      background-color: #f5f5f5;
      direction: rtl;
    }
    .container {
      max-width: 800px;
      margin: 20px auto;
      text-align: center;
    }
    .logo {
      margin-bottom: 20px;
    }
    select {
      padding: 10px;
      font-size: 16px;
    }
    /* עיצוב חלונית פופאפ */
    .modal {
      display: none; 
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      width: 90%;
      max-width: 800px;
      max-height: 80%;
      overflow-y: auto;
      position: relative;
    }
    .close {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #eee;
    }
    input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 5px;
    }
    button {
      padding: 5px 10px;
      margin: 2px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <img class="logo" src="https://y130160.github.io/form/לוגו בני ברק.png" alt="לוגו בני ברק" />
    <label for="studentSelect">בחר תלמיד:</label>
    <select id="studentSelect">
      <option value="">-- בחר תלמיד --</option>
    </select>
  </div>

  <!-- חלונית פופאפ להצגת נתוני דוח -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span id="closeModal" class="close">&times;</span>
      <h2>נתוני דוח</h2>
      <table id="reportTable">
        <thead>
          <tr>
            <th>עידכון</th>
            <th>מסכתות ופרקים</th>
            <th>סוג</th>
            <th>שותף</th>
            <th>הערות</th>
            <th>פעולות</th>
          </tr>
        </thead>
        <tbody>
          <!-- שורות יתמלאו דינמית -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // נתוני האיירטייבל
    const AIRTABLE_TOKEN = "patbiEZcpMDqQ8MTk.e891c6721030064a2dc13028d2008d46048ea912502cfdec2fa2ca18460ca749";
    const AIRTABLE_BASE_ID = "appanZGbMogA0mxRl";
    const STUDENTS_TABLE = "רשימת אברכים";
    const REPORT_TABLE = "עדכון דוח";

    // טעינת רשימת התלמידים עם קריאת API
    document.addEventListener("DOMContentLoaded", () => {
      fetchStudents();
      document.getElementById("studentSelect").addEventListener("change", handleStudentChange);
      document.getElementById("closeModal").addEventListener("click", closeModal);
    });

    function fetchStudents() {
      const url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${encodeURIComponent(STUDENTS_TABLE)}`;
      fetch(url, {
        headers: {
          "Authorization": "Bearer " + AIRTABLE_TOKEN
        }
      })
      .then(response => response.json())
      .then(data => {
        const select = document.getElementById("studentSelect");
        data.records.forEach(record => {
          const name = record.fields["משפחה ופרטי"];
          if (name) {
            const option = document.createElement("option");
            option.value = record.id;
            option.textContent = name;
            select.appendChild(option);
          }
        });
      })
      .catch(error => {
        alert("שגיאה בטעינת רשימת התלמידים: " + error);
      });
    }

    function handleStudentChange() {
      const studentId = this.value;
      if (studentId) {
        fetchReportData(studentId);
      }
    }

    function fetchReportData(studentId) {
      const filterFormula = encodeURIComponent(`SEARCH("${studentId}", ARRAYJOIN({תלמיד}))`);
      const url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${encodeURIComponent(REPORT_TABLE)}?filterByFormula=${filterFormula}`;
      fetch(url, {
        headers: {
          "Authorization": "Bearer " + AIRTABLE_TOKEN
        }
      })
      .then(response => response.json())
      .then(data => {
        let records = data.records;
        // מיון: קודם לפי "מסכתות ופרקים" (מהקטן לגדול), אחר כך לפי "סוג" (לפי סדר אלפביתי)
        records.sort((a, b) => {
          const m1 = parseInt(a.fields["מסכתות ופרקים"]) || 0;
          const m2 = parseInt(b.fields["מסכתות ופרקים"]) || 0;
          if (m1 !== m2) return m1 - m2;
          const s1 = a.fields["סוג"] || "";
          const s2 = b.fields["סוג"] || "";
          return s1.localeCompare(s2);
        });
        populateReportTable(records);
        openModal();
      })
      .catch(error => {
        alert("שגיאה בטעינת נתוני הדוח: " + error);
      });
    }

    function populateReportTable(records) {
      const tbody = document.getElementById("reportTable").querySelector("tbody");
      tbody.innerHTML = "";
      records.forEach(record => {
        const tr = document.createElement("tr");
        const fields = ["עידכון", "מסכתות ופרקים", "סוג", "שותף", "הערות"];
        fields.forEach(field => {
          const td = document.createElement("td");
          const input = document.createElement("input");
          input.type = "text";
          input.value = record.fields[field] || "";
          input.dataset.field = field;
          td.appendChild(input);
          tr.appendChild(td);
        });
        const tdActions = document.createElement("td");
        const saveBtn = document.createElement("button");
        saveBtn.textContent = "עדכן";
        saveBtn.addEventListener("click", () => updateRecord(record.id, tr));
        tdActions.appendChild(saveBtn);
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "מחק";
        deleteBtn.addEventListener("click", () => deleteRecord(record.id, tr));
        tdActions.appendChild(deleteBtn);
        tr.appendChild(tdActions);
        tbody.appendChild(tr);
      });
    }

    function updateRecord(recordId, tableRow) {
      const inputs = tableRow.querySelectorAll("input");
      let updatedFields = {};
      inputs.forEach(input => {
        updatedFields[input.dataset.field] = input.value;
      });
      const url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${encodeURIComponent(REPORT_TABLE)}/${recordId}`;
      fetch(url, {
        method: "PATCH",
        headers: {
          "Authorization": "Bearer " + AIRTABLE_TOKEN,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ fields: updatedFields })
      })
      .then(response => response.json())
      .then(data => {
        if(data.error) {
          alert("שגיאה בעדכון: " + data.error.message);
        } else {
          alert("עודכן בהצלחה");
        }
      })
      .catch(error => {
        alert("שגיאה בעדכון: " + error);
      });
    }

    function deleteRecord(recordId, tableRow) {
      const url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${encodeURIComponent(REPORT_TABLE)}/${recordId}`;
      fetch(url, {
        method: "DELETE",
        headers: {
          "Authorization": "Bearer " + AIRTABLE_TOKEN
        }
      })
      .then(response => response.json())
      .then(data => {
        if(data.error) {
          alert("שגיאה במחיקה: " + data.error.message);
        } else {
          tableRow.remove();
          alert("נמחק בהצלחה");
        }
      })
      .catch(error => {
        alert("שגיאה במחיקה: " + error);
      });
    }

    function openModal() {
      document.getElementById("modal").style.display = "block";
    }

    function closeModal() {
      document.getElementById("modal").style.display = "none";
    }
  </script>
</body>
</html>
